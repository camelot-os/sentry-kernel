name: enclave firmware quality checks

on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main

env:
  HOME: /home/user
  GITHUB_HOME: /home/user
  CI: true

jobs:
  sonar-scanner:
    name: SonarQube Quality Checks
    defaults:
      run:
        shell: bash
    runs-on: self-hosted
    container:
      image: docker-kulos-nexus.orange.ledgerlabs.net/codequalbot:v0.4.0
      credentials:
        username: ${{ secrets.KULOS_NEXUS_CI_RO_USER }}
        password: ${{ secrets.KULOS_NEXUS_CI_RO_PASSWORD }}

    steps:
      - name: Personalize
        uses: kulos-devops/action-personalize@bugfix/cleanup-hardcoded
        with:
          project_ref: ${{ github.ref }}
          ssh_key: ${{ secrets.GHE_SSH_KEY }}
          ssh_known_hosts: ${{ secrets.GHE_HOST_KEY }}
          token: ${{ secrets.GHE_CI_TOKEN }}
          crossfiles_git: 'outpost/meson-cross-files'

      - name: defconfig
        if: ${{ success() }}
        run: |
          defconfig configs/stm32f4_debug_defconfig
      - name: Meson Setup
        uses: kulos-devops/action-meson@v0.1.0
        with:
          actions: '["prefetch", "setup"]'
          cross_files: ${{ format('{0}/{1}', env.MESON_CROSS_FILES, 'arm-none-eabi-gcc.ini') }}
          options: '-Doptimization=0'
      - name: Sonar Scanner
        uses: kulos-devops/action-codequal@v0.2.0
        with:
          host: ${{ secrets.SONAR_HOST }}
          token: ${{ secrets.SONAR_TOKEN }}
          project: sentry-kernel
          build_cmd: 'ninja -C builddir'
