// SPDX-FileCopyrightText: 2023 Ledger SAS
// SPDX-License-Identifier: Apache-2.0

#include <sentry/ktypes.h>

#include "usart_defs.h"
#include "stm32-usart-dt.h"


{% set usart_ports = dts.get_compatible("st,stm32-usart") -%}

{%- set debug_usart = dts.chosen["sentry,debug_stdout"] %}
{%- if not debug_usart %}
#error "sentry,debug_stdout not define in device tree, check your configuration"
{%- elif debug_usart.status != "okay" %}
#error "sentry,debug_stdout is disabled, check usart status property"
{%- else %}
#define DEBUG_USART {{ debug_usart.label.upper() }}_PORT_ID
{%- endif %}


/**
 * \brief .rodata field: list of current platform USART ports
 */
static const stm32_usartport_desc_t stm32_usartports[] = {
    {% for port in usart_ports -%}
    {% if port.status and port.status == "okay" -%}
    {% set _, bus_id, clk_msk = port.clocks -%}
    /* {{ port.label }} port configuration */
    {
        .base_addr = {{ "%#08xUL"|format(port.reg[0]) }},
        .bus_id = {{ bus_id }},
        .clk_msk = {{ "%#08xUL"|format(clk_msk) }},
    },
    {% endif -%}
    {% endfor %}
    {} /* sentinel */
};

/**
 * @warning this is a private function, port id must be valid and checked by caller
 */
const stm32_usartport_desc_t * stm32_usartport_get_desc(void)
{
    return &stm32_usartports[DEBUG_USART];
}
